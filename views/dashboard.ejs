<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="https://hydra.newpaltz.edu/SUNYCAT.png" />
  <title>Hydra Dashboard - SUNY New Paltz</title>
</head>

<body class="bg-gray-50 text-gray-900">
  <header class="bg-[#052049] text-white">
    <div class="max-w-5xl mx-auto px-4 py-4 relative flex items-center gap-3">
      <img src="https://hydra.newpaltz.edu/SUNYCAT.png" alt="Hydra" class="h-8 w-8 rounded" />
      <h1 class="text-xl font-semibold">SUNY New Paltz - Hydra</h1>
      <a href="https://github.com/lettucegoblin/hydra-saml-auth" target="_blank"
        class="absolute top-4 right-4 text-white">
        <i class="fab fa-github text-2xl"></i>
      </a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <div class="bg-white rounded shadow p-6">
      <div class="border-b pb-4 mb-4 flex items-start justify-between gap-4">
        <div>
          <h2 class="text-2xl font-semibold text-[#052049]">Welcome, <%= user.firstName %>
              <%= user.lastName %>
          </h2>
          <p class="mt-1"><span class="font-semibold">Email:</span>
            <%= user.email %>
          </p>
          <p><span class="font-semibold">Username:</span>
            <%= user.displayName %>
          </p>
        </div>
        <div class="shrink-0">
          <a href="/logout?returnTo=https://hydra.newpaltz.edu/dashboard"
            class="inline-flex items-center px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Logout</a>
        </div>
      </div>

      <div class="mb-6">
        <h3 class="text-lg font-semibold">Authentication Status</h3>
        <p><span class="font-semibold">Status:</span> <span class="text-green-600 font-bold">Logged In</span></p>
      </div>


      <!-- Tabs -->
      <div>
        <div class="flex border-b mb-4" role="tablist">
          <button id="tab-minecraft" class="px-4 py-2 -mb-px border-b-2 border-[#052049] text-[#052049] font-medium"
            data-target="#panel-minecraft">Minecraft</button>
          <button id="tab-openwebui" class="px-4 py-2 text-gray-600 hover:text-gray-900"
            data-target="#panel-openwebui">OpenWebUI</button>
          <button id="tab-n8n" class="px-4 py-2 text-gray-600 hover:text-gray-900" data-target="#panel-n8n">n8n</button>
          <button id="tab-containers" class="px-4 py-2 text-gray-600 hover:text-gray-900"
            data-target="#panel-containers">Containers</button>
        </div>

        <section id="panel-minecraft">
          <h3 class="text-xl font-semibold mb-2">Minecraft Server</h3>
          <form id="minecraft-form" class="space-y-3 max-w-md">
            <div>
              <label for="minecraft-username" class="block text-sm font-medium">Minecraft Username</label>
              <input type="text" id="minecraft-username" name="minecraft-username"
                class="mt-1 block w-full rounded border border-gray-300 px-3 py-2" placeholder="e.g. Notch" />
              <p id="minecraft-help" class="text-xs text-gray-500 mt-2 hidden">Enter your Minecraft username (e.g. <span
                  class="font-mono">Notch</span>). This is <span class="font-bold">required</span> to join the server.
              </p>
            </div>
            <button type="submit"
              class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Save
              Username</button>
            <div id="minecraft-message" class="mt-3"></div>
          </form>
          <div class="mb-3">
            <label for="minecraft-server-url" class="block text-sm font-medium">Server Address (Copy to
              Minecraft)</label>
            <div class="flex items-center gap-2 mt-1">
              <input type="text" id="minecraft-server-url"
                class="block w-full rounded border border-gray-300 px-3 py-2 font-mono bg-gray-100"
                value="hydra.newpaltz.edu" readonly />
              <button type="button" id="copy-server-url"
                class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" title="Copy">Copy</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Paste this address into Minecraft to join the server.</p>
          </div>
          <p class="text-gray-700 mb-2">More Minecraft configuration at the <a
              href="https://hydra.newpaltz.edu/minecraftdashboard/" target="_blank"
              class="text-blue-600 underline">configuration panel</a>.</p>

        </section>

        <section id="panel-openwebui" class="hidden">
          <h3 class="text-xl font-semibold mb-2">OpenWebUI Account Management</h3>
          <p class="text-gray-700 mb-2">Welcome to the OpenWebUI account management portal. OpenWebUI provides a
            comprehensive interface for accessing AI models and managing your preferences in a secure environment.</p>
          <p class="text-gray-700 mb-4">Our institution hosts an OpenWebUI instance at <a
              href="https://gpt.hydra.newpaltz.edu" target="_blank"
              class="text-blue-600 underline">https://gpt.hydra.newpaltz.edu</a>. To utilize these services, you'll need
            to establish credentials through this portal.</p>

          <div id="webui-status-loading" class="text-gray-600">Checking your OpenWebUI account status...</div>

          <div id="webui-create-account" class="hidden">
            <p class="mb-2">You don't have an OpenWebUI account yet.</p>
            <form id="create-account-form" class="space-y-3">
              <div>
                <label for="new-password" class="block text-sm font-medium">Set Password</label>
                <input type="password" id="new-password" name="password" required
                  class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
              </div>
              <div>
                <label for="confirm-password" class="block text-sm font-medium">Confirm Password</label>
                <input type="password" id="confirm-password" name="confirm-password" required
                  class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
              </div>
              <button type="submit"
                class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Create
                OpenWebUI Account</button>
            </form>
            <div id="create-account-message" class="mt-3"></div>
          </div>

          <div id="webui-account-exists" class="hidden">
            <p class="mb-2">You have an existing OpenWebUI account.</p>
            <p><span class="font-semibold">Username:</span> <span id="webui-username"></span></p>
            <p><span class="font-semibold">Role:</span> <span id="webui-role"></span></p>

            <div id="change-password-section" class="mt-4">
              <h4 class="font-semibold mb-2">Change Password</h4>
              <form id="change-password-form" class="space-y-3">
                <div>
                  <label for="new-password-change" class="block text-sm font-medium">New Password</label>
                  <input type="password" id="new-password-change" name="new-password" required
                    class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
                </div>
                <div>
                  <label for="confirm-password-change" class="block text-sm font-medium">Confirm New Password</label>
                  <input type="password" id="confirm-password-change" name="confirm-password" required
                    class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
                </div>
                <button type="submit"
                  class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Update
                  Password</button>
              </form>
              <div id="change-password-message" class="mt-3"></div>
            </div>
          </div>
        </section>

        <section id="panel-n8n" class="hidden">
          <h3 class="text-xl font-semibold mb-2">n8n Account Management</h3>
          <p class="text-gray-700 mb-4">Manage your n8n automation account.</p>

          <div id="n8n-status-loading" class="text-gray-600">Checking your n8n account status...</div>
          <div id="n8n-account-exists" class="hidden">
            <p><span class="font-semibold">Status:</span> Found</p>
            <p><span class="font-semibold">Role:</span> <span id="n8n-role"></span></p>
            <p class="mt-2">You can log in to n8n at <a href="https://n8n.hydra.newpaltz.edu" target="_blank"
                class="text-blue-600 underline">https://n8n.hydra.newpaltz.edu</a></p>

            <div class="mt-4 border-t pt-4">
              <h4 class="font-semibold mb-2">Change n8n Password</h4>
              <form id="n8n-change-password-form" class="space-y-3">
                <div>
                  <label for="n8n-new-password" class="block text-sm font-medium">New Password</label>
                  <input type="password" id="n8n-new-password" name="new-password" required minlength="8"
                    class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
                  <p class="text-sm text-gray-500 mt-1">Must be at least 8 characters</p>
                </div>
                <div>
                  <label for="n8n-confirm-password" class="block text-sm font-medium">Confirm New Password</label>
                  <input type="password" id="n8n-confirm-password" name="confirm-password" required minlength="8"
                    class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
                </div>
                <button type="submit"
                  class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Update
                  n8n Password</button>
              </form>
              <div id="n8n-change-password-message" class="mt-3"></div>
            </div>
          </div>
          <div id="n8n-create-account" class="hidden">
            <p>No n8n account found. You can request an invite:</p>
            <form id="n8n-create-form" class="mt-3">
              <button type="submit"
                class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Request
                n8n Invite</button>
            </form>
            <div id="n8n-create-message" class="mt-3"></div>
          </div>
          <div id="n8n-invite" class="hidden mt-3">
            <p>Invite created. Use this link to complete setup:</p>
            <p><a id="n8n-invite-link" href="#" class="text-blue-600 underline" target="_blank"></a></p>
          </div>
        </section>
      </div>

      <section id="panel-containers" class="hidden">
        <h3 class="text-xl font-semibold mb-4">Student Container</h3>
        <p class="text-gray-700 mb-4">Manage your personal development container with VS Code, Jupyter, and custom port routing.</p>

        <!-- Container Status Section -->
        <div id="container-status-section" class="mb-6 border rounded p-4 bg-gray-50">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-lg font-semibold"><i class="fas fa-server"></i> Container Status</h4>
            <span id="container-state-badge" class="px-3 py-1 rounded text-sm font-medium"></span>
          </div>
          <div id="container-not-created" class="hidden">
            <p class="text-gray-600 text-sm mb-3">Your student container has not been created yet.</p>
            <button onclick="initContainer()" id="init-btn"
              class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">
              <i class="fas fa-plus-circle"></i> Initialize Container
            </button>
          </div>
          <div id="container-controls" class="hidden">
            <div class="flex gap-2">
              <button onclick="startContainer()" id="start-btn"
                class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">
                <i class="fas fa-play"></i> Start
              </button>
              <button onclick="stopContainer()" id="stop-btn"
                class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">
                <i class="fas fa-stop"></i> Stop
              </button>
              <button onclick="openLogs()" id="logs-btn"
                class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700">
                <i class="fas fa-file-alt"></i> Logs
              </button>
              <button onclick="openTerminal()" id="terminal-btn"
                class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
                <i class="fas fa-terminal"></i> Terminal
              </button>
              <button onclick="showWipeModal()" id="wipe-btn"
                class="px-4 py-2 rounded bg-yellow-500 text-white hover:bg-yellow-600">
                <i class="fas fa-exclamation-triangle"></i> Wipe Volume
              </button>
            </div>
          </div>
          <div id="container-message" class="mt-3"></div>
        </div>

        <!-- Wipe Confirmation Modal -->
        <div id="wipe-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
          <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
              <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
              </div>
              <h3 class="text-lg leading-6 font-medium text-gray-900">Wipe Container Volume?</h3>
              <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                  This will permanently delete all data in your container's volume, including all files and settings. This cannot be undone.
                  Your container will be recreated fresh.
                </p>
              </div>
              <div class="items-center px-4 py-3">
                <button id="cancel-wipe-btn"
                  class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">
                  Cancel
                </button>
                <button id="confirm-wipe-btn"
                  class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                  Yes, Wipe It
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Essential Services Section -->
        <div id="services-section" class="mb-6 border rounded p-4 hidden">
          <h4 class="text-lg font-semibold mb-3"><i class="fas fa-cogs"></i> Essential Services</h4>
          <div class="space-y-3">
            <div class="flex items-center justify-between border-b pb-3">
              <div class="flex items-center gap-3">
                <i class="fas fa-code text-indigo-600"></i>
                <div>
                  <div class="font-semibold">VS Code</div>
                  <div id="vscode-service-status" class="text-sm text-gray-600"></div>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="startService('code-server')" id="vscode-start-btn"
                  class="px-3 py-1 text-sm rounded bg-green-100 hover:bg-green-200 border border-green-300 text-green-700">
                  Start
                </button>
                <button onclick="stopService('code-server')" id="vscode-stop-btn"
                  class="px-3 py-1 text-sm rounded bg-red-100 hover:bg-red-200 border border-red-300 text-red-700">
                  Stop
                </button>
                <button onclick="openServiceURL('vscode')" id="vscode-open-btn"
                  class="px-3 py-1 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">
                  <i class="fas fa-external-link-alt"></i> Open
                </button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <i class="fas fa-book text-purple-600"></i>
                <div>
                  <div class="font-semibold">Jupyter Notebook</div>
                  <div id="jupyter-service-status" class="text-sm text-gray-600"></div>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="startService('jupyter')" id="jupyter-start-btn"
                  class="px-3 py-1 text-sm rounded bg-green-100 hover:bg-green-200 border border-green-300 text-green-700">
                  Start
                </button>
                <button onclick="stopService('jupyter')" id="jupyter-stop-btn"
                  class="px-3 py-1 text-sm rounded bg-red-100 hover:bg-red-200 border border-red-300 text-red-700">
                  Stop
                </button>
                <button onclick="openServiceURL('jupyter')" id="jupyter-open-btn"
                  class="px-3 py-1 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">
                  <i class="fas fa-external-link-alt"></i> Open
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Port Routing Section -->
        <div id="routing-section" class="mb-6 border rounded p-4 hidden">
          <h4 class="text-lg font-semibold mb-3"><i class="fas fa-route"></i> Port Routing</h4>
          <div class="overflow-x-auto mb-4">
            <table class="w-full text-sm">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-3 py-2 text-left">Endpoint</th>
                  <th class="px-3 py-2 text-left">Port</th>
                  <th class="px-3 py-2 text-left">URL</th>
                  <th class="px-3 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody id="routes-tbody" class="divide-y">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
          <div class="border-t pt-4">
            <h5 class="font-semibold mb-2">Add Custom Route</h5>
            <div class="flex gap-2 items-end">
              <div class="flex-1">
                <label class="block text-xs font-medium mb-1" for="new-endpoint">Endpoint</label>
                <input type="text" id="new-endpoint" placeholder="myapp"
                  class="w-full rounded border border-gray-300 px-3 py-2 text-sm" />
              </div>
              <div class="flex-1">
                <label class="block text-xs font-medium mb-1" for="new-port">Port</label>
                <input type="number" id="new-port" placeholder="3000" min="1024" max="65535"
                  class="w-full rounded border border-gray-300 px-3 py-2 text-sm" />
              </div>
              <button onclick="addRoute()"
                class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">
                <i class="fas fa-plus"></i> Add
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Route your container's internal ports to custom endpoints. Reserved ports: 8443 (VS Code), 8888 (Jupyter).</p>
          </div>
          <div id="routing-message" class="mt-3"></div>
        </div>
      </section>

    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const email = "<%= user.email %>";
      const name = "<%= user.firstName %> <%= user.lastName %>";
      const oid = "<%= user.oid %>";

      // Check if user exists in OpenWebUI
      checkUserExists(email, name);

      // Setup form handlers
      document.getElementById('create-account-form').addEventListener('submit', function (e) {
        e.preventDefault();
        createAccount(email, name);
      });

      document.getElementById('change-password-form').addEventListener('submit', function (e) {
        e.preventDefault();
        changePassword(email);
      });

      // Tabs
      const tabs = [
        { btn: 'tab-minecraft', panel: 'panel-minecraft' },
        { btn: 'tab-openwebui', panel: 'panel-openwebui' },
        { btn: 'tab-n8n', panel: 'panel-n8n' },
        { btn: 'tab-containers', panel: 'panel-containers' }
      ];
      tabs.forEach(t => {
        document.getElementById(t.btn).addEventListener('click', () => {
          tabs.forEach(x => {
            document.getElementById(x.btn).classList.remove('border-b-2', 'border-[#052049]', 'text-[#052049]');
            document.getElementById(x.btn).classList.add('text-gray-600');
            document.getElementById(x.panel).classList.add('hidden');
          });
          document.getElementById(t.btn).classList.add('border-b-2', 'border-[#052049]', 'text-[#052049]');
          document.getElementById(t.btn).classList.remove('text-gray-600');
          document.getElementById(t.panel).classList.remove('hidden');
        });
      });

      // Minecraft username fetch/save
      async function api(url, opts = {}) {
        const res = await fetch(url, opts);
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      }
      async function loadMinecraftUsername() {
        try {
          const res = await fetch('/minecraftdashboard/api/my-username');
          if (res.status === 401) {
            window.location.href = '/logout?returnTo=https://hydra.newpaltz.edu/dashboard';
            return;
          }
          if (!res.ok) throw new Error(await res.text());
          const { minecraft_username } = await res.json();
          const input = document.getElementById('minecraft-username');
          input.value = minecraft_username || '';
          document.getElementById('minecraft-help').classList.toggle('hidden', !!minecraft_username);
        } catch {
          document.getElementById('minecraft-help').classList.remove('hidden');
        }
      }
      document.getElementById('minecraft-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const input = document.getElementById('minecraft-username');
        const username = input.value.trim();
        const msg = document.getElementById('minecraft-message');
        if (!username) {
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Please enter a Minecraft username.</p>';
          document.getElementById('minecraft-help').classList.remove('hidden');
          return;
        }
        try {
          await api('/minecraftdashboard/api/my-username', { method: 'POST', body: JSON.stringify({ minecraft_username: username }), headers: { 'Content-Type': 'application/json' } });
          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Username saved!</p>';
          document.getElementById('minecraft-help').classList.add('hidden');
        } catch (err) {
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Failed to save username.</p>';
        }
      });
      loadMinecraftUsername();

      // Copy Minecraft server URL to clipboard
      document.getElementById('copy-server-url').addEventListener('click', function () {
        const input = document.getElementById('minecraft-server-url');
        input.select();
        input.setSelectionRange(0, 99999); // For mobile
        document.execCommand('copy');
        this.textContent = 'Copied!';
        setTimeout(() => { this.textContent = 'Copy'; }, 1500);
      });

      // n8n: status + create flow
      checkN8nStatus();
      document.getElementById('n8n-create-form').addEventListener('submit', function (e) {
        e.preventDefault();
        createN8nAccount();
      });
      document.getElementById('n8n-change-password-form').addEventListener('submit', function (e) {
        e.preventDefault();
        changeN8nPassword();
      });

      // Container management - load status when tab is opened
      let containerStatusInterval = null;
      document.getElementById('tab-containers').addEventListener('click', () => {
        loadContainerStatus();
        // Start polling every 5 seconds
        if (containerStatusInterval) clearInterval(containerStatusInterval);
        containerStatusInterval = setInterval(loadContainerStatus, 5000);
      });

      // Stop polling when switching away from containers tab
      tabs.forEach(t => {
        if (t.btn !== 'tab-containers') {
          document.getElementById(t.btn).addEventListener('click', () => {
            if (containerStatusInterval) {
              clearInterval(containerStatusInterval);
              containerStatusInterval = null;
            }
          });
        }
      });

      // Container Management Functions
      async function loadContainerStatus() {
        try {
          const res = await fetch('/dashboard/api/containers/status');
          const data = await res.json();

          const badge = document.getElementById('container-state-badge');
          const notCreated = document.getElementById('container-not-created');
          const controls = document.getElementById('container-controls');
          const servicesSection = document.getElementById('services-section');
          const routingSection = document.getElementById('routing-section');

          if (!data.exists) {
            // Container not created
            badge.textContent = 'Not Created';
            badge.className = 'px-3 py-1 rounded text-sm font-medium bg-gray-200 text-gray-700';
            notCreated.classList.remove('hidden');
            controls.classList.add('hidden');
            servicesSection.classList.add('hidden');
            routingSection.classList.add('hidden');
          } else {
            // Container exists
            notCreated.classList.add('hidden');
            controls.classList.remove('hidden');

            if (data.running) {
              badge.textContent = 'Running';
              badge.className = 'px-3 py-1 rounded text-sm font-medium bg-green-100 text-green-700';
              servicesSection.classList.remove('hidden');
              routingSection.classList.remove('hidden');

              // Load services and routes
              loadServices();
              loadRoutes();
            } else {
              badge.textContent = 'Stopped';
              badge.className = 'px-3 py-1 rounded text-sm font-medium bg-yellow-100 text-yellow-700';
              servicesSection.classList.add('hidden');
              routingSection.classList.add('hidden');
            }
          }
        } catch (err) {
          console.error('Failed to load container status:', err);
        }
      }

      window.initContainer = async function () {
        const msg = document.getElementById('container-message');
        msg.innerHTML = '<p class="text-gray-600">Initializing container...</p>';
        try {
          const res = await fetch('/dashboard/api/containers/init', { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Container initialized successfully!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);
          loadContainerStatus();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${err.message || 'Failed to initialize'}</p>`;
        }
      };

      window.startContainer = async function () {
        const msg = document.getElementById('container-message');
        msg.innerHTML = '<p class="text-gray-600">Starting container...</p>';
        try {
          const res = await fetch('/dashboard/api/containers/start', { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Container started!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);
          loadContainerStatus();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${err.message || 'Failed to start'}</p>`;
        }
      };

      window.stopContainer = async function () {
        if (!confirm('Stop your container? Services will be unavailable until you start it again.')) return;
        const msg = document.getElementById('container-message');
        msg.innerHTML = '<p class="text-gray-600">Stopping container...</p>';
        try {
          const res = await fetch('/dashboard/api/containers/stop', { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Container stopped!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);
          loadContainerStatus();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${err.message || 'Failed to stop'}</p>`;
        }
      };

      window.showWipeModal = function () {
        document.getElementById('wipe-modal').classList.remove('hidden');
      };

      document.getElementById('cancel-wipe-btn').addEventListener('click', () => {
        document.getElementById('wipe-modal').classList.add('hidden');
      });

      document.getElementById('confirm-wipe-btn').addEventListener('click', () => {
        document.getElementById('wipe-modal').classList.add('hidden');
        wipeContainer();
      });

      async function wipeContainer() {
        const msg = document.getElementById('container-message');
        msg.innerHTML = '<p class="text-gray-600">Wiping container volume and recreating...</p>';
        try {
          const res = await fetch('/dashboard/api/containers/wipe', { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Container wiped and recreated successfully!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 5000);
          loadContainerStatus();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${err.message || 'Failed to wipe container'}</p>`;
        }
      }

      async function loadServices() {
        try {
          const res = await fetch('/dashboard/api/containers/services');
          const data = await res.json();

          if (!data.success || !data.containerRunning) return;

          const services = data.services || [];
          const vscode = services.find(s => s.name === 'code-server');
          const jupyter = services.find(s => s.name === 'jupyter');

          // Update VS Code status
          if (vscode) {
            document.getElementById('vscode-service-status').textContent = vscode.running ? '● Running' : '○ Stopped';
            document.getElementById('vscode-service-status').className = vscode.running ? 'text-sm text-green-600' : 'text-sm text-gray-500';
          }

          // Update Jupyter status
          if (jupyter) {
            document.getElementById('jupyter-service-status').textContent = jupyter.running ? '● Running' : '○ Stopped';
            document.getElementById('jupyter-service-status').className = jupyter.running ? 'text-sm text-green-600' : 'text-sm text-gray-500';
          }
        } catch (err) {
          console.error('Failed to load services:', err);
        }
      }

      window.startService = async function (serviceName) {
        try {
          const res = await fetch(`/dashboard/api/containers/services/${serviceName}/start`, { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          setTimeout(loadServices, 1000);
        } catch (err) {
          alert('Failed to start service: ' + err.message);
        }
      };

      window.stopService = async function (serviceName) {
        try {
          const res = await fetch(`/dashboard/api/containers/services/${serviceName}/stop`, { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          setTimeout(loadServices, 1000);
        } catch (err) {
          alert('Failed to stop service: ' + err.message);
        }
      };

      window.openServiceURL = function (endpoint) {
        const username = "<%= user.email %>".split('@')[0];
        const url = `<%= baseUrl %>/students/${username}/${endpoint}/`;
        window.open(url, '_blank');
      };

      async function loadRoutes() {
        try {
          const res = await fetch('/dashboard/api/containers/routes');
          const data = await res.json();

          if (!data.success) return;

          const tbody = document.getElementById('routes-tbody');
          tbody.innerHTML = '';

          const routes = data.routes || [];
          routes.forEach(route => {
            const row = document.createElement('tr');
            const isReserved = route.endpoint === 'vscode' || route.endpoint === 'jupyter';

            row.innerHTML = `
              <td class="px-3 py-2 font-mono">${route.endpoint}</td>
              <td class="px-3 py-2">${route.port}</td>
              <td class="px-3 py-2">
                <a href="${route.url}" target="_blank" class="text-blue-600 underline text-xs">
                  <i class="fas fa-external-link-alt"></i> ${route.url}
                </a>
              </td>
              <td class="px-3 py-2">
                ${isReserved
                  ? '<span class="text-xs text-gray-500">Default</span>'
                  : `<button onclick="deleteRoute('${route.endpoint}')" class="px-2 py-1 text-xs rounded bg-red-100 hover:bg-red-200 text-red-700">
                      <i class="fas fa-trash"></i> Delete
                    </button>`
                }
              </td>
            `;
            tbody.appendChild(row);
          });
        } catch (err) {
          console.error('Failed to load routes:', err);
        }
      }

      window.addRoute = async function () {
        const endpoint = document.getElementById('new-endpoint').value.trim().toLowerCase();
        const port = Number(document.getElementById('new-port').value);
        const msg = document.getElementById('routing-message');

        if (!endpoint || !/^[a-z0-9-]{1,40}$/.test(endpoint)) {
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Invalid endpoint name (alphanumeric and hyphens only)</p>';
          return;
        }

        if (!port || port < 1024 || port > 65535) {
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Port must be between 1024-65535</p>';
          return;
        }

        try {
          msg.innerHTML = '<p class="text-gray-600 text-sm">Adding route...</p>';
          const res = await fetch('/dashboard/api/containers/routes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endpoint, port })
          });
          const data = await res.json();

          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2 text-sm">Route added successfully!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);

          document.getElementById('new-endpoint').value = '';
          document.getElementById('new-port').value = '';

          loadRoutes();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">${err.message || 'Failed to add route'}</p>`;
        }
      };

      window.deleteRoute = async function (endpoint) {
        if (!confirm(`Delete route "${endpoint}"?`)) return;

        const msg = document.getElementById('routing-message');
        try {
          const res = await fetch(`/dashboard/api/containers/routes/${encodeURIComponent(endpoint)}`, { method: 'DELETE' });
          const data = await res.json();

          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2 text-sm">Route deleted!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);

          loadRoutes();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">${err.message || 'Failed to delete route'}</p>`;
        }
      };

      window.openLogs = function () {
        const w = window.open('', '_blank', 'width=900,height=600');
        w.document.write('<!DOCTYPE html><html><head><title>Container Logs</title>');
        w.document.write('<style>body { margin: 0; padding: 0; background: #1a1a1a; font-family: monospace; }');
        w.document.write('#log { white-space: pre-wrap; margin: 0; padding: 12px; color: #ddd; height: 100vh; overflow: auto; font-size: 12px; line-height: 1.4; }</style></head>');
        w.document.write('<body><pre id="log"></pre>');
        w.document.write('<sc' + 'ript>');
        w.document.write('const es = new EventSource("/dashboard/api/containers/logs/stream");');
        w.document.write('const pre = document.getElementById("log");');
        w.document.write('es.onmessage = (e) => { pre.textContent += e.data + "\\n"; pre.scrollTop = pre.scrollHeight; };');
        w.document.write('es.onerror = () => { pre.textContent += "\\n[Stream closed]\\n"; es.close(); };');
        w.document.write('window.addEventListener("beforeunload", () => es.close());');
        w.document.write('</sc' + 'ript></body></html>');
      };

      window.openTerminal = function () {
        const username = "<%= user.email %>".split('@')[0];
        const containerName = `student-${username}`;

        const w = window.open('', '_blank', 'width=1000,height=700');
        const doc = w.document;

        doc.open();
        doc.write('<!DOCTYPE html><html><head><title>Terminal: ' + containerName + '</title></head><body></body></html>');
        doc.close();

        // Add stylesheet
        const link = doc.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css';
        doc.head.appendChild(link);

        // Add styles
        const style = doc.createElement('style');
        style.textContent = 'body { margin: 0; padding: 0; background: #000; } #terminal { height: 100vh; padding: 8px; }';
        doc.head.appendChild(style);

        // Add terminal div
        const terminalDiv = doc.createElement('div');
        terminalDiv.id = 'terminal';
        doc.body.appendChild(terminalDiv);

        // Load xterm.js and initialize
        const script = doc.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js';
        script.onload = function () {
          const term = new w.Terminal({
            convertEol: true,
            fontFamily: "monospace",
            fontSize: 14,
            cursorBlink: true,
            theme: { background: "#000000", foreground: "#ffffff" }
          });
          term.open(doc.getElementById("terminal"));
          term.writeln("Connecting to container...");

          const proto = location.protocol === "https:" ? "wss" : "ws";
          const ws = new WebSocket(proto + "://" + location.host + "/dashboard/ws/containers/" + encodeURIComponent(containerName) + "/exec");
          ws.binaryType = "arraybuffer";
          ws.onopen = function () { term.clear(); term.writeln("Connected! Type commands below:"); term.write("$ "); };
          ws.onmessage = function (ev) { term.write(new Uint8Array(ev.data)); };
          ws.onclose = function () { term.writeln("\r\n[Connection closed]"); };
          ws.onerror = function () { term.writeln("\r\n[Connection error]"); };
          term.onData(function (data) { if (ws.readyState === WebSocket.OPEN) ws.send(data); });
        };
        doc.head.appendChild(script);
      };
    });

    // Function to check if user exists in OpenWebUI
    function checkUserExists(email, name) {
      // This would be an AJAX call to your backend
      fetch('/dashboard/api/webui/check-user', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
      })
        .then(response => response.json())
        .then(data => {
          document.getElementById('webui-status-loading').classList.add('hidden');

          if (data.exists) {
            // Show account exists section
            document.getElementById('webui-account-exists').classList.remove('hidden');
            document.getElementById('webui-username').textContent = data.username;
            document.getElementById('webui-role').textContent = data.role;
          } else {
            // Show create account section
            document.getElementById('webui-create-account').classList.remove('hidden');
          }
        })
        .catch(error => {
          console.error('Error checking user:', error);
          document.getElementById('webui-status-loading').innerHTML =
            '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error checking account status. Please try again later.</p>';
        });
    }

    // n8n helpers
    function checkN8nStatus() {
      fetch('/dashboard/api/n8n/status', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          document.getElementById('n8n-status-loading').classList.add('hidden');
          if (data.exists === false) {
            // User doesn't exist - show create account section
            document.getElementById('n8n-create-account').classList.remove('hidden');
          } else if (data.id && data.isPending) {
            // User exists but is pending - show they need to complete setup
            document.getElementById('n8n-create-account').classList.remove('hidden');
            const msg = document.getElementById('n8n-create-message');
            msg.innerHTML = '<p class="text-yellow-700 bg-yellow-100 border border-yellow-200 rounded p-2">You have a pending invite. Click "Request n8n Invite" to resend the invitation link.</p>';
          } else if (data.id) {
            // User exists and is active - show account exists section
            document.getElementById('n8n-account-exists').classList.remove('hidden');
            if (data.role) document.getElementById('n8n-role').textContent = data.role;
          } else {
            // Unexpected response
            document.getElementById('n8n-status-loading').innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Unexpected response from n8n.</p>';
          }
        })
        .catch(err => {
          console.error('Error checking n8n status:', err);
          document.getElementById('n8n-status-loading').innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error checking n8n status.</p>';
        });
    }

    function createN8nAccount() {
      // Email is taken from server-side auth; body is not required
      const msg = document.getElementById('n8n-create-message');
      fetch('/dashboard/api/n8n/create-user', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          // If array [] -> already has account, no invite
          if (data.length == 0) {
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Account already active. No invite needed.</p>';
            return;
          }
          data = data[0]; // Get first item
          if (data && data.user && data.user.inviteAcceptUrl) {
            const link = data.user.inviteAcceptUrl;
            document.getElementById('n8n-invite-link').textContent = link;
            document.getElementById('n8n-invite-link').href = link;
            document.getElementById('n8n-invite').classList.remove('hidden');
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Invite created successfully.</p>';
          } else if (data && data.error) {
            msg.innerHTML = `<p class=\"text-red-700 bg-red-100 border border-red-200 rounded p-2\">${data.error}</p>`;
          } else {
            msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Unexpected response.</p>';
          }
        })
        .catch(err => {
          console.error('Error creating n8n account:', err);
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Failed to create n8n account.</p>';
        });
    }

    function changeN8nPassword() {
      const newPassword = document.getElementById('n8n-new-password').value;
      const confirmPassword = document.getElementById('n8n-confirm-password').value;
      const msg = document.getElementById('n8n-change-password-message');

      // Check if passwords match
      if (newPassword !== confirmPassword) {
        msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Passwords do not match.</p>';
        return;
      }

      // Check password length
      if (newPassword.length < 8) {
        msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Password must be at least 8 characters.</p>';
        return;
      }

      msg.innerHTML = '<p class="text-gray-600">Changing password...</p>';

      fetch('/dashboard/api/n8n/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ newPassword })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Password changed successfully!</p>';
            document.getElementById('n8n-change-password-form').reset();
          } else {
            msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${data.message || 'Failed to change password'}</p>`;
          }
        })
        .catch(err => {
          console.error('Error changing n8n password:', err);
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error changing password. Please try again.</p>';
        });
    }

    // Function to create an account
    function createAccount(email, name) {
      const password = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const messageDiv = document.getElementById('create-account-message');

      // Check if passwords match
      if (password !== confirmPassword) {
        messageDiv.innerHTML = '<p class="message error">Passwords do not match.</p>';
        return;
      }

      // This would be an AJAX call to your backend
      fetch('/dashboard/api/webui/create-account', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: email,
          name: name,
          password: password
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            messageDiv.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Account created successfully!</p>';
            // Refresh account status after a short delay
            setTimeout(() => {
              checkUserExists(email, name);
            }, 2000);
          } else {
            messageDiv.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error: ${data.message}</p>`;
          }
        })
        .catch(error => {
          console.error('Error creating account:', error);
          messageDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error creating account. Please try again later.</p>';
        });
    }

    // Function to change password
    function changePassword(email) {
      const newPassword = document.getElementById('new-password-change').value;
      const confirmPassword = document.getElementById('confirm-password-change').value;
      const messageDiv = document.getElementById('change-password-message');

      // Check if passwords match
      if (newPassword !== confirmPassword) {
        messageDiv.innerHTML = '<p class="message error">Passwords do not match.</p>';
        return;
      }

      // This would be an AJAX call to your backend
      fetch('/dashboard/api/webui/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: email,
          password: newPassword
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            messageDiv.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Password updated successfully!</p>';
            // Clear the form
            document.getElementById('change-password-form').reset();
          } else {
            messageDiv.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error: ${data.message}</p>`;
          }
        })
        .catch(error => {
          console.error('Error changing password:', error);
          messageDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error updating password. Please try again later.</p>';
        });
    }
  </script>
</body>

</html>